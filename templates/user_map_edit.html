<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>munrosWithFriends</title>
  <link rel="icon" href="/static/images/munro.png" type="image/png">

  <link rel="stylesheet" href="/static/css/styles.css">

  <script>window.API_KEY = "{{ os_apikey }}";</script>

  <script type="module" src="/static/js/search_map_sidebar.js"></script>
  <script type="module" src="/static/js/navigate_to_coords.js"></script>
  <script type="module" src="/static/js/toggle_side_bar.js"></script>
  <script type="module" src="/static/js/munro_bag.js" defer></script>
  <script type="module" src="/static/js/munro_del.js" defer></script>

  <!--leaflet stylesheet-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
<canvas id="fireworks"></canvas>
<script type="module">import { startFireworksOnMap } from '/static/js/fireworks.js';</script>

<div id="map"></div>

<!--add sidebar table with color for bags-->
<div id="table_layer" class="collapsed">
  <table id="mountainTable">
    <thead style="position: fixed; top: 0; background: white; z-index: 1000;">
      <th style="text-align: left; width: 125px">
        Name ({{ bag_total }}/282)<br>
        <input type="text" id="searchInput" placeholder="üîç" style="width: 100px; text-align: left;">
      </th>
    <tbody style="display:block; margin-top: 30px;">
    <tbody>
      {% for loc in log_data %}
        <tr>
          <td>
            {% if loc.date is none %}
              <button onclick="goToLocation({{ loc.latitude }}, {{ loc.longitude }})">
              {{ loc.name }}
            </button>
            {% else %}
            <button style = "background-color: #93C572;"
                  onclick="goToLocation({{ loc.latitude }}, {{ loc.longitude }})">
              {{ loc.name }}
            </button>
            
            {% endif %}

          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Toggle Button -->
<button id="toggleSidebar">Show table</button>

<!--add base map-->
<script src="/static/js/base_map.js"></script>

<script>
//convert jinja to js to avoid template with js combo nightmare
const locations = {{ log_data|tojson|safe }};

//gap icon
const gapIcon = L.icon({
    iconUrl: '/static/images/gap.png',
    iconSize: [18, 18],
    iconAnchor: [10, 10],
    popupAnchor: [0, -10]
});

//bag icon
const bagIcon = L.icon({
    iconUrl: "{{ user_img }}",
    iconSize: [18, 18],
    iconAnchor: [10, 10],
    popupAnchor: [0, -10]
});

locations.forEach(loc => {
    const peakIcon = loc.date === null ? gapIcon : bagIcon;

    const marker = L.marker([loc.latitude, loc.longitude], { icon: peakIcon })
        .addTo(map)
        .bindTooltip(loc.name,
                  {permanent:false,
                    direction:'top',
                    offset:[-1,-7]
                  })
        //generate popup content for bag or gap munro
        .on('click', e => {
            const popupContent = `
            <div id=pop-up style="width:300px;">
              <h3 style="margin: 0;">
                ${loc.date === null
                    ? `${loc.name}`

                    : `üèîÔ∏è&#8288;${loc.name}&#8288;üëú`}
              </h3>

              <p style="margin: 0; font-size: 12px; text-align: center;">
                <a href="${loc.whl_url}" target="_blank">walkhighlands</a>
              </p><br>
        
              
              ${loc.date === null
                ? `<form id="bag-form">
                    <input type="hidden" id="munro-id" value="${loc.munro_id}">
                    <input type="date" id="date" class="form-element" style="width:120px;height:25px;" required>
                    <textarea id="distance" placeholder="Distance" class="form-element" style="width:120px; height:20px; margin-top:5px;"></textarea>
                    <textarea id="friends" placeholder="Friends" class="form-element" style="margin-top:5px; height:20px;"></textarea>
                    <textarea id="notes" placeholder="Notes" class="form-element" style="height:40px; margin-top:5px;"></textarea>
                    <textarea id="private" placeholder="Any info I don't want public" class="form-element" height:20px; margin-top:5px;"></textarea>
                    
                    <div style="text-align:center; margin-top:10px;">
                      <button type="submit"
                      style="white-space:nowrap; background-color:gold; color:black; font-weight:bold; border-radius:5px; padding:2px 3px; cursor:pointer;">
                        In the bag üèîÔ∏è‚Üíüëú
                      </button>
                    </div>
                  </form>`
        
                : `<div>
                    <div style="display:grid; grid-template-columns:max-content 1fr; row-gap:4px; column-gap:8px; font-size:13px; color:#000;">
                      <strong>Date:</strong><span>${loc.date}</span>
                      ${loc.distance ? `<strong>Distance:</strong><span>${loc.distance}</span>` : ''}
                      ${loc.friends ? `<strong>Friends:</strong><span>${loc.friends}</span>` : ''}
                      ${loc.notes ? `<strong>Notes:</strong><span>${loc.notes}</span>` : ''}
                      ${loc.private ? `<strong>Private:</strong><span>${loc.private}</span>` : ''}
                    </div>

                    <div style="grid-column: 1 / -1;">
                      <hr style="border: none; height: 0.5px; background-color: #333; margin: 10px 10px;">
                    </div>

                    <div style="display:flex; justify-content:center; margin-top:10px;">
                      <form id="del-form" style="display:flex; align-items:center; gap:10px; flex-wrap:nowrap;">
                        <input type="hidden" id="munro-id" value="${loc.munro_id}">

                        <label style="display:flex; align-items:center; gap:0px;font-size: 10px; font-color:black; font-weight:bold;"">
                          <input type="checkbox" name="conf" required>
                          Confirm
                        </label>

                        <button type="submit"
                          style="white-space:nowrap; background-color:red; color:black; font-weight:bold; border-radius:5px; padding:2px 3px; cursor:pointer;">
                          Delete üòß
                        </button>
                      </form>                   
                    </div>
                                    
                  </div>`}
            </div>
            `;
          L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map)              
              });
});
</script>

<div id="navigate">
  <button style="width: 120px; height: 22px; text-align: center;"onclick="window.location.href='/{{ user }}/view'">View page</button>
  <button style="width: 120px; height: 22px; text-align: center;"onclick="window.location.href='/{{ user }}/profile'">Profile page</button>
  <button style="width: 120px; height: 22px; text-align: center;" onclick="window.location.href='{{ url_for('auth.logout') }}'">Logout</button>
</div>

</body>
</html>