<!DOCTYPE html>
<html>
<head>
  <title>OS Mountain Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style> 
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      }

    #map { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; }

    #table_layer {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 140px;
      height: 98.5dvh;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd; 
      z-index: 1000;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transition: transform 0.5s ease;
      padding: 10px;
      }

    #mountainTable td button {
        text-align: left;
        vertical-align: top;
        white-space: normal; 
        width: 100%;
        }

    #login {
      position: fixed;   
      top: 20px;
      right: 20px;
      padding: 5px 20px;
      background-color: white;
      color: black;
      border: 2px solid black;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-align: top;
      width: 240px;
      height: 210px;
      text-align: top;
    }

    #searchInput::placeholder {
        text-align: right;
        }

    #table_layer.collapsed {
      transform: translateX(-100%);
    }
  
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 170px;
      z-index: 1100;
      padding: 5px 10px;b
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      transition: left 0.5s ease; 
      }
    

  /* Make all Leaflet popups slightly transparent */
  .leaflet-popup-content-wrapper {
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 3px 14px rgba(0,0,0,0.4);
    }
  .leaflet-popup-tip {
    background: rgba(255, 255, 255, 0.8);
    }

  </style>
  </head>

  <body>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchInput');
    const rows = document.querySelectorAll('#mountainTable tbody tr');
    searchInput.addEventListener('input', function () {
      const filter = searchInput.value.toLowerCase();
      rows.forEach(row => {
        const nameText = row.cells[0].textContent.toLowerCase();
        row.style.display = nameText.includes(filter) ? '' : 'none';
      });
    });
  });
</script>

<div id="map"></div>

<script>
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function goToLocation(lat, lng) {
    
    const coords = [lat-0.00, lng-0.002];

    window.map.setView(coords, 10);

    await sleep(500);

    const circle = L.circle(coords, {
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0,
      radius: 1200
    }).addTo(window.map);

    await sleep(1500);
    window.map.removeLayer(circle);
  }
</script>

<div id="table_layer">
  <table id="mountainTable">
    <colgroup><col style="width: 120px"></colgroup>
    <thead>
      <th style="text-align: left;">
        Name (282)<br>
        <input type="text" id="searchInput" placeholder="ðŸ”" style="width: 100px; text-align: left;">
      </th>
    </thead>
    <tbody>
      {% for loc in locations %}
        <tr>
          <td>
            <button {{ loc.style|e }} 
                    onclick="goToLocation({{ loc.latitude }}, {{ loc.longitude }})">
              {{ loc.name }}
            </button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

<!-- Toggle Button -->
<button id="toggleSidebar">Hide table</button>

<script>
  const sidebar = document.getElementById("table_layer");
  const toggleBtn = document.getElementById("toggleSidebar");

  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");

    // Optional: move the toggle button with the sidebar
    if (sidebar.classList.contains("collapsed")) {
      toggleBtn.style.left = "10px";  // adjust position when collapsed
      toggleBtn.textContent = "Show table";
    } else {
      toggleBtn.style.left = "170px";
      toggleBtn.textContent = "Hide table";
    }
  });
</script>

<style>
  /* Add a small gap between username and password fields */
  #login-form input[name="user"],
  #signup-form input[name="user"],
  #login-form input[name="password"],
  #signup-form input[name="password"],
  #login-form button,
  #signup-form button,
  .links {
    margin-top: 8px; /* Adjust the gap size as needed */
    display: block;  /* Ensures it appears on a new line */
  }
</style>

<div id="login">
  <h2 id="form-title">Login</h2>

  <!-- Login Form -->
  <form id="login-form" action="/login" method="POST">
    <input type="text" name="user" placeholder="Username" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit" style="display:inline-block;">Login</button> 
    <div id="login-error" style="display:inline-block; margin-left:10px; margin-right:10px; color: red;">{{ error|default('') }}</div>
  </form>

  <!-- Signup Form -->
  <form id="signup-form" action="/signup" method="POST" style="display: none;">
    <input type="text" name="email" placeholder="Email" required>
    <input type="text" name="user" placeholder="Username" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Sign Up</button>
  </form>

  <div class="links">
    <a href="#" id="toggle-form">Sign Up</a> | 
    <a href="#">Forgot Password?</a>
  </div>
</div>

<script>
const toggleLink = document.getElementById('toggle-form');
const loginForm = document.getElementById('login-form');
const signupForm = document.getElementById('signup-form');
const formTitle = document.getElementById('form-title');

toggleLink.addEventListener('click', function(e) {
  e.preventDefault();

  if (signupForm.style.display === 'none') {
    // Show signup, hide login
    loginForm.style.display = 'none';
    signupForm.style.display = 'block';
    formTitle.textContent = 'Sign Up';
    toggleLink.textContent = 'Back to Login';
  } else {
    // Show login, hide signup
    signupForm.style.display = 'none';
    loginForm.style.display = 'block';
    formTitle.textContent = 'Login';
    toggleLink.textContent = 'Sign Up';
  }
});
</script>

<script>

  var map = L.map('map', {
    center: [57.08, -4.02],
    zoom: 7,
    minZoom: 7,
    maxZoom: 13,
    zoomControl: false 
  });
  window.map = map;

  const apiKey = "X5uEx0qVA9UPMJDgFfyjHNWsGNuhyOuF";

  // Base layers
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  L.tileLayer(`https://api.os.uk/maps/raster/v1/zxy/Outdoor_3857/{z}/{x}/{y}.png?key=${apiKey}`, {
    attribution: '&copy; Ordnance Survey',
    maxZoom: 18,
    minZoom: 7,
    tileSize: 512,
    zoomOffset: -1,
    noWrap: true,
    continuousWorld: true,
    className: 'os-tiles'
  }).addTo(map);

  const peakIcon = L.icon({
    iconUrl: '/static/images/peak.png',
    iconSize: [18, 18],
    iconAnchor: [10, 10],
    popupAnchor: [0, -10]
  });


  {% for loc in locations %}
  L.marker([{{ loc.latitude }}, {{ loc.longitude }}], { icon: peakIcon })
    .addTo(map)
    .bindTooltip({{ loc.name|tojson }}, {
      permanent: false,
      direction: 'top',
      offset: [-1, -7]
    })
    .on('click', function (e) {
    // Create custom popup content
    const popupContent = `
            <div style="
          width: 200px;
          border-radius: 8px;
          font-family: Arial, sans-serif;
          color: #333;
          padding: 1px;
          
      ">
        <h3 style="
            margin: 0 0 10px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            text-align: left;
        ">
          {{ loc.name|e }}
        </h3>

    <div style="
      display: grid;
      grid-template-columns: max-content 1fr;
      row-gap: 4px;
      column-gap: 8px;
      font-size: 13px;
      color: #000;">

        <strong>Height:</strong>
        <span>{{ loc.height }}m</span>

              <strong>County:</strong>
        <span>{{ loc.county }}</span>


        <strong>SMC region:</strong>
        <span>{{ loc.region }}</span>
    </div>
      `;

      L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(map);
    });

{% endfor %}

</script>

</body>
</html>