<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>munrosWithFriends</title>
  <link rel="icon" href="/static/images/munro.png" type="image/png">

  <link rel="stylesheet" href="/static/css/styles.css">

  <script type="module" src="/static/js/user_del.js"></script>
  <script type="module">import { download } from '/static/js/download_data.js';</script>

  <script>
    const user = {{ user | tojson }};

    const users = {{ other_users | tojson }};
    const user_list = users.map(item => item.user_name);

    const user_links = user_list.reduce((acc, curr) => {
                            acc[curr] = `../${curr}/view`;
                            return acc;
                            }, {});

    const data = {{ log_data|tojson|safe }}
    const bag_dates = data.map(item => item.date);
    const filtered_dates = bag_dates.filter(item => item !== null && item !== undefined);
    filtered_dates.sort()

    const bag_years = filtered_dates.map(str => str.slice(0, 4));
    
    const counts = {};
    bag_years.forEach(item => {
        counts[item] = (counts[item] || 0) + 1;
        });

        // Step 2: Find the most common element
        let count = 0;
        let year = null;

        for (const [key, value] of Object.entries(counts)) {
        if (value > count) {
            count = value;
            year = key;
        }
        }

</script>

</head>

<body style="margin-left: 20px; margin-top: 20px;">

<div id="col-container" style="display: flex; gap: 3px;">

<div id="profile-summary" style="background-color: lightblue; margin-left: 40px; margin-top: 40px;color:#000;border: 1px solid black; width: 300px;padding:20px 30px"></div>
    
    <script>
        document.getElementById('profile-summary').innerHTML = 
        `<h1 style="display:inline; margin-right:10px;">${user}</h1>
        
        <br><br>
        <div style="background-color: white; border: 2px solid black; width:70px; padding:5px 5px" id="imageContainer"></div>
        <br>

        <div style="display:grid; grid-template-columns:max-content 1fr; row-gap:8px; column-gap:15px; font-size:18px;">

            <strong>Total bags:</strong><span>{{ bag_total }}/282</span>
            <strong>First bag:</strong><span>${filtered_dates[0]}</span>
            <strong>Last bag:</strong><span>${filtered_dates[filtered_dates.length - 1]}</span>
            <strong>Best year:</strong><span>${count} bags, ${year}</span>
        
        </div>

        <p>Upload new icon image (.png only just now)</p>
   
        <input type="file" id="fileInput" accept="image/*"><br>
        <button id="uploadBtn">Upload</button>

        <p id="status"></p>

        <button id="downloadBtn">Download my data</button>

        <div style="grid-column: 1 / -1;">
                <hr style="border: none; height: 0.5px; background-color: #333; margin: 20px 20px;">
        </div>

        <div style="display:flex; margin-top:10px;">
        <form style="display:flex; flex-direction: column; width: 100%;">
            <label style="font-size:12px; margin-bottom:8px;">
            <input type="checkbox" name="conf" required>
            Confirm - permanently delete your profile and data
            </label>

            <button id="del-profile" type="submit"
            style="margin-left:auto; white-space:nowrap; width:120px; background-color:red; color:black; font-weight:bold; border-radius:5px; padding:2px 3px; cursor:pointer;">
            Delete profile ðŸ˜§
            </button>
        </form>
        </div>
        `
    document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const status = document.getElementById('status');

            if (!file) {
                status.textContent = "Please select a file.";
                return;
            }

            const validTypes = ['image/png',
                                //'image/jpeg',
                                //'image/jpg',
                                //'image/gif'
                                 ];
            
                                 if (!validTypes.includes(file.type)) {
                status.textContent = "Invalid file type.";
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            status.textContent = result.message || result.error;
            
            if (response.ok) {
                window.location.reload()
            };
        });
             
        const imgContainer = document.getElementById('imageContainer')
        const imgPath = `/static/images/${user}.png`;
        
        const img = new Image();
        img.src = imgPath;

        img.width = 70;
        img.height = 70;

        img.onload = () => {
            imgContainer.appendChild(img);
        };
        img.onerror = () => {

            const img = new Image();
            img.src = `/static/images/bag.png`;

            img.width = 70;
            img.height = 70;

            imgContainer.appendChild(img);
        };

        document.getElementById('downloadBtn').addEventListener('click', () => {

            fetch('/download', {
                method: 'POST',
            })
            .then(response => response.blob()) // Convert response to Blob
            .then(blob => {
                // Create a URL for the blob
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.csv'; // Filename for download
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url); // Clean up
            })
            .catch(error => console.error('Error:', error));
                });
    </script>

<div id="search-users" style="background-color: lightblue; margin-left: 40px; margin-top: 40px;color:#000;border: 1px solid black; width: 180px;padding:1px 20px">
<h1 style="margin-right:10px;">Find friends</h1>
    <input type="text" id="search" placeholder="Search..." style="margin-bottom: 10px; padding: 5px; width: 130px;">
        <div id="buttons-container"></div>
</div>



<script>
const container = document.getElementById('buttons-container');
    const searchInput = document.getElementById('search');

    // Convert object to array of {label, link}
    const usersArray = Object.entries(user_links).map(([label, link]) => ({ label, link }));

function renderButtons(filter = "") {
    container.innerHTML = "";
    usersArray
        .filter(item => item.label.toLowerCase().includes(filter.toLowerCase()))
        .forEach(item => {
            const btn = document.createElement('button');
            btn.style.display = "flex";          // Flex layout
            btn.style.alignItems = "center";     // Vertical centering
            btn.style.justifyContent = "center"; // Horizontal centering
            btn.style.width = "100%";
            btn.style.marginBottom = "5px";
            btn.style.gap = "10px";              // Space between image and text
            btn.style.padding = "10px";          // Optional padding for better look

            // Create the image element
            const img = document.createElement('img');
            img.src = `/static/images/${item.label}.png`;
            img.alt = item.label;
            img.style.width = "24px";   // Adjust as needed
            img.style.height = "24px";

            // Add image and text
            btn.appendChild(img);
            btn.appendChild(document.createTextNode(item.label));

            // Click action
            btn.onclick = () => window.location.href = item.link;

            container.appendChild(btn);
        });
}

    // Initial render
    renderButtons();

    // Filter on input
    searchInput.addEventListener('input', (e) => {
        renderButtons(e.target.value);
    });
</script>

<div style="display: flex;
    flex-direction: column; margin-left: 40px; margin-top: 40px; gap: 10px; border: 1px solid black;border-radius: 5px; padding: 10px 10px;height: 75px; background-color: lightblue">
  <button style="width: 100px; text-align: center;"onclick="window.location.href='/{{ user }}/edit'">Edit page</button>
  <button style="width: 100px; text-align: center;"onclick="window.location.href='/{{ user }}/view'">View page</button>
  <button style="width: 100px; text-align: center;" onclick="window.location.href='{{ url_for('logout') }}'">Logout</button>
</div>


</div>
</body>
</html>


